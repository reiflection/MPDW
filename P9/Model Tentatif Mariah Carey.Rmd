---
title: "Model Tentatif Mariah Carey"
author: "Kaylila Kireinahana"
date: "2023-10-24"
output: html_document
---

# Packages

```{r}
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(forecast)
library(TSA)
library(TTR)
library(aTSA)
library(graphics)
```

# Penyiapan Data

```{r}
mcl <- rio::import("https://raw.githubusercontent.com/reiflection/MPDW/main/Data/Mariah%20Carey%20Listeners.csv")
head(mcl)
str(mcl)
```

```{r}
lis <- ts(mcl$Listeners)
lis.train <- lis[1:413]
lis.test <- lis[414:516]
lis.train.ts <- ts(mcl$Listeners[1:413], frequency = 104)
lis.test.ts <- ts(mcl$Listeners[414:516], frequency = 104)
```

# Plot Data Deret Waktu

```{r}
par(mfrow=c(2,2))
ts.plot(lis, xlab="Waktu", ylab="Pendengar", 
        main = "Plot Penuh")
ts.plot(lis.train, xlab="Waktu", ylab="Pendengar", 
        main = "Plot Latih")
ts.plot(lis.test, xlab="Waktu", ylab="Pendengar", 
        main = "Plot Uji")
```

# Uji Stasioneritas Data

## Plot ACF

```{r}
acf(lis.train.ts)
pacf(lis.train.ts)
```

## Uji ADF

```{r}
tseries::adf.test(lis.train.ts)
```

## Uji Box-Cox

```{r}
lis.index <- seq(1:413)
lis.bc = boxcox(lis.train.ts ~ lis.index, lambda = seq(-5, 5, by=0.1))
#Nilai Rounded Lambda
lis.lambda <- lis.bc$x[which.max(lis.bc$y)]
lis.lambda
#SK
lis.bc$x[lis.bc$y > max(lis.bc$y) - 1/2 * qchisq(.95,1)]
```

## Transformasi Box-Cox

```{r}
#Transformasi Box-Cox (y*=y^lambda)
lis.n <- as.numeric(lis.train.ts)
lis.bc1 <- 1/lis.n^2
lis.bc2 <- ts(lis.bc1, frequency=104)
ts.plot(lis.bc2)
```

### Plot Box-Cox

```{r}
lis.index2 <- seq(1:413)
lis.bc.2 = boxcox(lis.bc2 ~ lis.index2, lambda = seq(0, 2, by=0.1))
#Nilai Rounded Lambda
lis.lambda2 <- lis.bc.2$x[which.max(lis.bc.2$y)]
lis.lambda2
#SK
lis.bc.2$x[lis.bc.2$y > max(lis.bc.2$y) - 1/2 * qchisq(.95,1)]
```

### Plot ACF

```{r}
acf(lis.bc2)
tseries::adf.test(lis.bc2)
```

```{r}
pacf(lis.bc2)
```

### Differencing

```{r}
lis.diff <- diff(lis.bc2, differences = 1) 
plot.ts(lis.diff, lty=1, xlab="waktu", ylab="Data Difference 1", main="Plot Difference 1")
```

```{r}
acf(lis.diff)
```

```{r}
tseries::adf.test(lis.diff)
```

```{r}
pacf(lis.diff)
```

#### Differencing Musiman

```{r}
lis.diffmus = diff(lis.diff, lag=104)
plot.ts(lis.diffmus, lty=1, xlab="waktu", ylab="Data Difference Musiman", main="Plot Difference Musiman")
```

#### Uji ACF

```{r}
acf(lis.diffmus)
```

#### Plot ADF

```{r}
tseries::adf.test(lis.diffmus)
```

#### Plot PACF

```{r}
pacf(lis.diffmus)
```

### Plot EACF

```{r}
eacf(lis.diffmus)
```

ARIMA(1,1,0), ARIMA(0,1,1), ARIMA(1,1,1), ARIMA(2,1,1), ARIMA(3,1,1), ARIMA(0,1,2), ARIMA(1,1,2)

# Pendugaan Model Tentatif

## SARIMA(1,1,0)(0,1,0)

```{r}
lis.model1 <- Arima(lis.train.ts, order = c(1,1,0),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model1) 
lmtest::coeftest(lis.model1) #tidak ada parameter yang signifikan
```

## SARIMA(0,1,1)(0,1,0)

```{r}
lis.model2 <- Arima(lis.train.ts, order = c(0,1,1),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model2) 
lmtest::coeftest(lis.model2) #tidak ada parameter yang signifikan
```

## SARIMA(1,1,1)(0,1,0)

```{r}
lis.model3 <- Arima(lis.train.ts, order = c(1,1,1),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model3) #AIC 9706.25
lmtest::coeftest(lis.model3) #seluruh parameter yang signifikan
```

## SARIMA(2,1,1,)(0,1,0)

```{r}
lis.model4 <- Arima(lis.train.ts, order = c(2,1,1),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model4) #AIC 9717.16
lmtest::coeftest(lis.model4) #seluruh parameter yang signifikan
```

## SARIMA(3,1,1)(0,1,0)

```{r}
lis.model5 <- Arima(lis.train.ts, order = c(3,1,1),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model5) #AIC 9718.43
lmtest::coeftest(lis.model5) #tidak seluruh parameter yang signifikan
```

## SARIMA(0,1,2)(0,1,0)

```{r}
lis.model6 <- Arima(lis.train.ts, order = c(0,1,2),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model6) #AIC 9717.21
lmtest::coeftest(lis.model6) #tidak seluruh parameter yang signifikan
```

yang dipilih SARIMA(1,1,1)(0,1,0)

## Overfitting

### SARIMA(2,1,1)(0,1,0)

```{r}
lis.model4 <- Arima(lis.train.ts, order = c(2,1,1),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model4) #AIC 9717.16
lmtest::coeftest(lis.model4) #seluruh parameter yang signifikan
```

### SARIMA(1,1,2)(0,1,0)

```{r}
lis.model3a <- Arima(lis.train.ts, order = c(1,1,2),
                    seasonal = list(order = c(0,1,0),
                                    period=104))
summary(lis.model3a) #AIC 9706.25
lmtest::coeftest(lis.model3a) # tidak seluruh parameter yang signifikan
```

tetap dipilih model sebelum overfitting.

# Pengujian Asumsi

## Eksplorasi Data

```{r}
checkresiduals(lis.model3)
lis.sisaan <- lis.model3$residuals 
par(mfrow=c(2,2)) 
qqnorm(lis.sisaan) 
qqline(lis.sisaan, col = "blue", lwd = 2) 
plot(c(1:length(lis.sisaan)),lis.sisaan) 
acf(lis.sisaan) 
pacf(lis.sisaan) 
par(mfrow = c(1,1))
```

## Uji Formal

```{r}
#1) Sisaan Menyebar Normal 
ks.test(lis.sisaan,"pnorm")  #tak tolak H0 > sisaan menyebar normal
```

```{r}
#2) Sisaan saling bebas/tidak ada autokorelasi 
Box.test(lis.sisaan, type = "Ljung")  #tak tolak H0 > sisaan saling bebas
```

```{r}
#3) Sisaan homogen 
Box.test((lis.sisaan)^2, type = "Ljung")  #tak tolak H0 > sisaan homogen
```

```{r}
#4) Nilai tengah sisaan sama dengan nol 
t.test(lis.sisaan, mu = 0, conf.level = 0.95)  #tak tolak h0 > nilai tengah sisaan sama dengan 0
```

```{r}
library(olsrr)
ols_plot_resid_lev(lis.model3)
```

```{r}
plot()
```

# Peramalan

```{r}
lis.ramalan <- forecast::forecast(lis.model3, h = 103) 
lis.ramalan
lis.data.ramalan <- lis.ramalan$mean
plot(lis.ramalan)
```

```{r}
lis.pt <- lis.train[413] #nilai akhir data latih
lis.hasil.forc.Diff <- lis.data.ramalan
lis.hasil <- diffinv(lis.hasil.forc.Diff, differences = 1) + lis.pt
#has.1 sama hasilnta dengan: cumsum(c(pt_1,hasil.forc.Diff))
ts.plot(lis.train.ts, lis.hasil)
```

```{r}
lis.perbandingan <- matrix(data=c(head(lis.test, n=103), lis.hasil[-1]),
                     nrow = 103, ncol = 2)
colnames(lis.perbandingan) <- c("Aktual","Hasil Forecast")
lis.perbandingan
accuracy(ts(lis.hasil[-1]), head(lis.test, n=103))
```

